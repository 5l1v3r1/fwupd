From 7d78347549f80c5ce545ee74424ac2c5713480af Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Wed, 31 Aug 2016 11:41:24 +0100
Subject: [PATCH 3/3] Fix libfwupd self tests when a host-provided fwupd is not
 available

Resolves: https://github.com/hughsie/fwupd/issues/64
---
 libfwupd/fwupd-client.c    | 14 ++++++++++++--
 libfwupd/fwupd-self-test.c |  6 ++++++
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/libfwupd/fwupd-client.c b/libfwupd/fwupd-client.c
index 425a96d..603bbde 100644
--- a/libfwupd/fwupd-client.c
+++ b/libfwupd/fwupd-client.c
@@ -250,8 +250,18 @@ fwupd_client_fixup_dbus_error (GError *error)
 
 	/* parse the remote error */
 	name = g_dbus_error_get_remote_error (error);
-	error->domain = FWUPD_ERROR;
-	error->code = fwupd_error_from_string (name);
+	if (g_str_has_prefix (name, FWUPD_DBUS_INTERFACE)) {
+		error->domain = FWUPD_ERROR;
+		error->code = fwupd_error_from_string (name);
+	} else if (g_error_matches (error,
+				    G_DBUS_ERROR,
+				    G_DBUS_ERROR_SERVICE_UNKNOWN)) {
+		error->domain = FWUPD_ERROR;
+		error->code = FWUPD_ERROR_NOT_SUPPORTED;
+	} else {
+		error->domain = FWUPD_ERROR;
+		error->code = FWUPD_ERROR_INTERNAL;
+	}
 	g_dbus_error_strip_remote_error (error);
 }
 
diff --git a/libfwupd/fwupd-self-test.c b/libfwupd/fwupd-self-test.c
index 0a8072b..23eddeb 100644
--- a/libfwupd/fwupd-self-test.c
+++ b/libfwupd/fwupd-self-test.c
@@ -165,6 +165,9 @@ fwupd_client_devices_func (void)
 	if (array == NULL &&
 	    g_error_matches (error, FWUPD_ERROR, FWUPD_ERROR_NOTHING_TO_DO))
 		return;
+	if (array == NULL &&
+	    g_error_matches (error, FWUPD_ERROR, FWUPD_ERROR_NOT_SUPPORTED))
+		return;
 	g_assert_no_error (error);
 	g_assert (array != NULL);
 	g_assert_cmpint (array->len, >, 0);
@@ -189,6 +192,9 @@ fwupd_client_updates_func (void)
 	if (array == NULL &&
 	    g_error_matches (error, FWUPD_ERROR, FWUPD_ERROR_NOTHING_TO_DO))
 		return;
+	if (array == NULL &&
+	    g_error_matches (error, FWUPD_ERROR, FWUPD_ERROR_NOT_SUPPORTED))
+		return;
 	g_assert_no_error (error);
 	g_assert (array != NULL);
 	g_assert_cmpint (array->len, >, 0);
-- 
2.7.4

